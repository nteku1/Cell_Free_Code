clear all;


%% Define simulation setup
%% Leverages tools from Emil Björnson and Luca Sanguinetti, “Making Cell-Free Massive MIMO Competitive With MMSE Processing and Centralized Implementation,” IEEE Transactions on Wireless Communications, 
%% vol. 19, no. 1, pp. 77-90, January 2020.


%Number of Monte Carlo setups

%Number of channel realizations per setup
nbrOfRealizations = 1; %1000;
%Number of APs in the cell-free network
L = 20;

%Number of UEs

K = 6;

%Number of antennas per AP
N = 1;


%Number of pilots per coherence block
tau_p = 20;

%Uplink transmit power per UE (mW)
p = 100;


% fileID3 = fopen('best_vvvver1_endfortoday__1_29_20APs_Single_Path_loss.txt','w');
% fileID4 = fopen('best_vvvver1_endfortoday__1_29_20APs_Single_Path_loss_p2.txt','w');
% fileID3 = fopen('LASTTTTTTTT____20single.txt','w');
% fileID4 = fopen('LASTTTTTTT___20single_p2.txt','w');
% % % % fileID3 = fopen('vvvvvvvvvvvv100m_single_path_loss_25AP_12_13.txt','w');
% % % % fileID4 = fopen('vvvvvvvvvvvv100m_single_path_loss_25AP_12_13_p2.txt','w');

for iiii = 1:101000
    if iiii == 1 %initialize both user and AP positions
        [gainOverNoisedB,R,pilotIndexCF,pilotIndexSC,APpositions,UEpositions] = generateSetup_threeslope_rev_rec_100me(L,K,N,tau_p,1,p);
    else
        %get more realizations using initialized AP and user positions.
         [gainOverNoisedB,R,pilotIndexCF,pilotIndexSC] = generateSetup_threeslope_rev_justuserpos_change22_100me(L,K,N,tau_p,1,p,APpositions,UEpositions); 
    end
        betaVal = db2pow(gainOverNoisedB);
    %Get channel realizations
   [Hhat_AP,H_AP,B_AP] = functionChannelEstimates(R,nbrOfRealizations,L,K,N,tau_p,pilotIndexCF,p);
  
    
if iiii <= 100000% 10000 realizations for training set, 1000 for test set

for jlock = 1:K
    % Write to training set files based on choice of Aps
    
%10 APs    
% fprintf(fileID3,'%.5f %.5f %.5f %.5f %.5f %.5f %.5f %.5f %.5f %.5f %.5f %.5f %.5f %.5f %.5f %.5f %.5f %.5f %.5f %.5f\n',...
%           real(H_AP(1,jlock)), imag(H_AP(1,jlock)),real(H_AP(2,jlock)),imag(H_AP(2,jlock)),real(H_AP(3,jlock)), imag(H_AP(3,jlock)),...
%           real(H_AP(4,jlock)), imag(H_AP(4,jlock)),real(H_AP(5,jlock)),imag(H_AP(5,jlock)),real(H_AP(6,jlock)), imag(H_AP(6,jlock)),...
%           real(H_AP(7,jlock)), imag(H_AP(7,jlock)),real(H_AP(8,jlock)),imag(H_AP(8,jlock)),real(H_AP(9,jlock)), imag(H_AP(9,jlock)),...
%           real(H_AP(10,jlock)), imag(H_AP(10,jlock)));

 % 15 APs
%  fprintf(fileID3,'%.5f %.5f %.5f %.5f %.5f %.5f %.5f %.5f %.5f %.5f %.5f %.5f %.5f %.5f %.5f %.5f %.5f %.5f %.5f %.5f %.5f %.5f %.5f %.5f %.5f %.5f %.5f %.5f %.5f %.5f\n',...
%   real(H_AP(1,jlock)), imag(H_AP(1,jlock)),real(H_AP(2,jlock)),imag(H_AP(2,jlock)),real(H_AP(3,jlock)), imag(H_AP(3,jlock)),...
%   real(H_AP(4,jlock)), imag(H_AP(4,jlock)),real(H_AP(5,jlock)),imag(H_AP(5,jlock)),real(H_AP(6,jlock)), imag(H_AP(6,jlock)),...
%   real(H_AP(7,jlock)), imag(H_AP(7,jlock)),real(H_AP(8,jlock)),imag(H_AP(8,jlock)),real(H_AP(9,jlock)), imag(H_AP(9,jlock)),...
%   real(H_AP(10,jlock)), imag(H_AP(10,jlock)),real(H_AP(11,jlock)), imag(H_AP(11,jlock)),real(H_AP(12,jlock)), imag(H_AP(12,jlock)),...
%   real(H_AP(13,jlock)), imag(H_AP(13,jlock)),real(H_AP(14,jlock)), imag(H_AP(14,jlock)),real(H_AP(15,jlock)), imag(H_AP(15,jlock)));  
%      
%       
      
% % % %  20 Aps     
fprintf(fileID3,'%.5f %.5f %.5f %.5f %.5f %.5f %.5f %.5f %.5f %.5f %.5f %.5f %.5f %.5f %.5f %.5f %.5f %.5f %.5f %.5f %.5f %.5f %.5f %.5f %.5f %.5f %.5f %.5f %.5f %.5f %.5f %.5f %.5f %.5f %.5f %.5f %.5f %.5f %.5f %.5f\n',...
  real(H_AP(1,jlock)), imag(H_AP(1,jlock)),real(H_AP(2,jlock)),imag(H_AP(2,jlock)),real(H_AP(3,jlock)), imag(H_AP(3,jlock)),...
  real(H_AP(4,jlock)), imag(H_AP(4,jlock)),real(H_AP(5,jlock)),imag(H_AP(5,jlock)),real(H_AP(6,jlock)), imag(H_AP(6,jlock)),...
  real(H_AP(7,jlock)), imag(H_AP(7,jlock)),real(H_AP(8,jlock)),imag(H_AP(8,jlock)),real(H_AP(9,jlock)), imag(H_AP(9,jlock)),...
  real(H_AP(10,jlock)), imag(H_AP(10,jlock)),real(H_AP(11,jlock)), imag(H_AP(11,jlock)),real(H_AP(12,jlock)), imag(H_AP(12,jlock)),...
  real(H_AP(13,jlock)), imag(H_AP(13,jlock)),real(H_AP(14,jlock)), imag(H_AP(14,jlock)),real(H_AP(15,jlock)), imag(H_AP(15,jlock)),...
  real(H_AP(16,jlock)), imag(H_AP(16,jlock)),real(H_AP(17,jlock)), imag(H_AP(17,jlock)),real(H_AP(18,jlock)), imag(H_AP(18,jlock)),...
  real(H_AP(19,jlock)), imag(H_AP(19,jlock)),real(H_AP(20,jlock)), imag(H_AP(20,jlock)));  

%25 APs
% fprintf(fileID3,'%.5f %.5f %.5f %.5f %.5f %.5f %.5f %.5f %.5f %.5f %.5f %.5f %.5f %.5f %.5f %.5f %.5f %.5f %.5f %.5f %.5f %.5f %.5f %.5f %.5f %.5f %.5f %.5f %.5f %.5f %.5f %.5f %.5f %.5f %.5f %.5f %.5f %.5f %.5f %.5f %.5f %.5f %.5f %.5f %.5f %.5f %.5f %.5f %.5f %.5f\n',...
%   real(H_AP(1,jlock)), imag(H_AP(1,jlock)),real(H_AP(2,jlock)),imag(H_AP(2,jlock)),real(H_AP(3,jlock)), imag(H_AP(3,jlock)),...
%   real(H_AP(4,jlock)), imag(H_AP(4,jlock)),real(H_AP(5,jlock)),imag(H_AP(5,jlock)),real(H_AP(6,jlock)), imag(H_AP(6,jlock)),...
%   real(H_AP(7,jlock)), imag(H_AP(7,jlock)),real(H_AP(8,jlock)),imag(H_AP(8,jlock)),real(H_AP(9,jlock)), imag(H_AP(9,jlock)),...
%   real(H_AP(10,jlock)), imag(H_AP(10,jlock)),real(H_AP(11,jlock)), imag(H_AP(11,jlock)),real(H_AP(12,jlock)), imag(H_AP(12,jlock)),...
%   real(H_AP(13,jlock)), imag(H_AP(13,jlock)),real(H_AP(14,jlock)), imag(H_AP(14,jlock)),real(H_AP(15,jlock)), imag(H_AP(15,jlock)),...
%   real(H_AP(16,jlock)), imag(H_AP(16,jlock)),real(H_AP(17,jlock)), imag(H_AP(17,jlock)),real(H_AP(18,jlock)), imag(H_AP(18,jlock)),...
%   real(H_AP(19,jlock)), imag(H_AP(19,jlock)),real(H_AP(20,jlock)), imag(H_AP(20,jlock)),real(H_AP(21,jlock)), imag(H_AP(21,jlock)),... 
%   real(H_AP(22,jlock)), imag(H_AP(22,jlock)),real(H_AP(23,jlock)), imag(H_AP(23,jlock)),real(H_AP(24,jlock)), imag(H_AP(24,jlock)),...
%   real(H_AP(25,jlock)), imag(H_AP(25,jlock)));  


%50 APs
%fprintf(fileID3,'%.5f %.5f %.5f %.5f %.5f %.5f %.5f %.5f %.5f %.5f %.5f %.5f %.5f %.5f %.5f %.5f %.5f %.5f %.5f %.5f %.5f %.5f %.5f %.5f %.5f %.5f %.5f %.5f %.5f %.5f %.5f %.5f %.5f %.5f %.5f %.5f %.5f %.5f %.5f %.5f %.5f %.5f %.5f %.5f %.5f %.5f %.5f %.5f %.5f %.5f %.5f %.5f %.5f %.5f %.5f %.5f %.5f %.5f %.5f %.5f %.5f %.5f %.5f %.5f %.5f %.5f %.5f %.5f %.5f %.5f %.5f %.5f %.5f %.5f %.5f %.5f %.5f %.5f %.5f %.5f %.5f %.5f %.5f %.5f %.5f %.5f %.5f %.5f %.5f %.5f %.5f %.5f %.5f %.5f %.5f %.5f %.5f %.5f %.5f %.5f\n',...
%  real(H_AP(1,jlock)), imag(H_AP(1,jlock)),real(H_AP(2,jlock)),imag(H_AP(2,jlock)),real(H_AP(3,jlock)), imag(H_AP(3,jlock)),...
%  real(H_AP(4,jlock)), imag(H_AP(4,jlock)),real(H_AP(5,jlock)),imag(H_AP(5,jlock)),real(H_AP(6,jlock)), imag(H_AP(6,jlock)),...
%  real(H_AP(7,jlock)), imag(H_AP(7,jlock)),real(H_AP(8,jlock)),imag(H_AP(8,jlock)),real(H_AP(9,jlock)), imag(H_AP(9,jlock)),...
%  real(H_AP(10,jlock)), imag(H_AP(10,jlock)),real(H_AP(11,jlock)), imag(H_AP(11,jlock)),real(H_AP(12,jlock)), imag(H_AP(12,jlock)),...
%  real(H_AP(13,jlock)), imag(H_AP(13,jlock)),real(H_AP(14,jlock)), imag(H_AP(14,jlock)),real(H_AP(15,jlock)), imag(H_AP(15,jlock)),...
%  real(H_AP(16,jlock)), imag(H_AP(16,jlock)),real(H_AP(17,jlock)), imag(H_AP(17,jlock)),real(H_AP(18,jlock)), imag(H_AP(18,jlock)),...
%  real(H_AP(19,jlock)), imag(H_AP(19,jlock)),real(H_AP(20,jlock)), imag(H_AP(20,jlock)),real(H_AP(21,jlock)), imag(H_AP(21,jlock)),... 
%  real(H_AP(22,jlock)), imag(H_AP(22,jlock)),real(H_AP(23,jlock)), imag(H_AP(23,jlock)),real(H_AP(24,jlock)), imag(H_AP(24,jlock)),...
%  real(H_AP(25,jlock)), imag(H_AP(25,jlock)),real(H_AP(26,jlock)), imag(H_AP(26,jlock)),real(H_AP(27,jlock)), imag(H_AP(27,jlock)),...
%  real(H_AP(28,jlock)), imag(H_AP(28,jlock)),real(H_AP(29,jlock)), imag(H_AP(29,jlock)),real(H_AP(30,jlock)), imag(H_AP(30,jlock)),...
%  real(H_AP(31,jlock)), imag(H_AP(31,jlock)),real(H_AP(32,jlock)), imag(H_AP(32,jlock)),real(H_AP(33,jlock)), imag(H_AP(33,jlock)),...
%  real(H_AP(34,jlock)), imag(H_AP(34,jlock)),real(H_AP(35,jlock)), imag(H_AP(35,jlock)),real(H_AP(36,jlock)), imag(H_AP(36,jlock)),...
%  real(H_AP(37,jlock)), imag(H_AP(37,jlock)),real(H_AP(38,jlock)), imag(H_AP(38,jlock)),real(H_AP(39,jlock)), imag(H_AP(39,jlock)),...
%  real(H_AP(40,jlock)), imag(H_AP(40,jlock)),real(H_AP(41,jlock)), imag(H_AP(41,jlock)),real(H_AP(42,jlock)), imag(H_AP(42,jlock)),...
%  real(H_AP(43,jlock)), imag(H_AP(43,jlock)),real(H_AP(44,jlock)), imag(H_AP(44,jlock)),real(H_AP(45,jlock)), imag(H_AP(45,jlock)),...
%  real(H_AP(46,jlock)), imag(H_AP(46,jlock)),real(H_AP(47,jlock)), imag(H_AP(47,jlock)),real(H_AP(48,jlock)), imag(H_AP(48,jlock)),...
%  real(H_AP(49,jlock)), imag(H_AP(49,jlock)),real(H_AP(50,jlock)), imag(H_AP(50,jlock)));  

end
      
      
else



for block = 1:K
    %Generating corresponding test set files

    %10 APs
% fprintf(fileID4,'%.5f %.5f %.5f %.5f %.5f %.5f %.5f %.5f %.5f %.5f %.5f %.5f %.5f %.5f %.5f %.5f %.5f %.5f %.5f %.5f\n',...
%           real(H_AP(1,block)), imag(H_AP(1,block)),real(H_AP(2,block)),imag(H_AP(2,block)),real(H_AP(3,block)), imag(H_AP(3,block)),...
%           real(H_AP(4,block)), imag(H_AP(4,block)),real(H_AP(5,block)),imag(H_AP(5,block)),real(H_AP(6,block)), imag(H_AP(6,block)),...
%           real(H_AP(7,block)), imag(H_AP(7,block)),real(H_AP(8,block)),imag(H_AP(8,block)),real(H_AP(9,block)), imag(H_AP(9,block)),...
%           real(H_AP(10,block)), imag(H_AP(10,block)));
%    

%15 Aps
% fprintf(fileID4,'%.5f %.5f %.5f %.5f %.5f %.5f %.5f %.5f %.5f %.5f %.5f %.5f %.5f %.5f %.5f %.5f %.5f %.5f %.5f %.5f %.5f %.5f %.5f %.5f %.5f %.5f %.5f %.5f %.5f %.5f\n',...
%           real(H_AP(1,block)), imag(H_AP(1,block)),real(H_AP(2,block)),imag(H_AP(2,block)),real(H_AP(3,block)), imag(H_AP(3,block)),...
%           real(H_AP(4,block)), imag(H_AP(4,block)),real(H_AP(5,block)),imag(H_AP(5,block)),real(H_AP(6,block)), imag(H_AP(6,block)),...
%           real(H_AP(7,block)), imag(H_AP(7,block)),real(H_AP(8,block)),imag(H_AP(8,block)),real(H_AP(9,block)), imag(H_AP(9,block)),...
%           real(H_AP(10,block)), imag(H_AP(10,block)),real(H_AP(11,jlock)), imag(H_AP(11,jlock)),real(H_AP(12,jlock)), imag(H_AP(12,jlock)),...
%           real(H_AP(13,jlock)), imag(H_AP(13,jlock)),real(H_AP(14,jlock)), imag(H_AP(14,jlock)),real(H_AP(15,jlock)), imag(H_AP(15,jlock)));     
%       
%       
      
%20 Aps      
fprintf(fileID4,'%.5f %.5f %.5f %.5f %.5f %.5f %.5f %.5f %.5f %.5f %.5f %.5f %.5f %.5f %.5f %.5f %.5f %.5f %.5f %.5f %.5f %.5f %.5f %.5f %.5f %.5f %.5f %.5f %.5f %.5f %.5f %.5f %.5f %.5f %.5f %.5f %.5f %.5f %.5f %.5f\n',...
          real(H_AP(1,block)), imag(H_AP(1,block)),real(H_AP(2,block)),imag(H_AP(2,block)),real(H_AP(3,block)), imag(H_AP(3,block)),...
          real(H_AP(4,block)), imag(H_AP(4,block)),real(H_AP(5,block)),imag(H_AP(5,block)),real(H_AP(6,block)), imag(H_AP(6,block)),...
          real(H_AP(7,block)), imag(H_AP(7,block)),real(H_AP(8,block)),imag(H_AP(8,block)),real(H_AP(9,block)), imag(H_AP(9,block)),...
          real(H_AP(10,block)), imag(H_AP(10,block)),real(H_AP(11,block)), imag(H_AP(11,block)),real(H_AP(12,block)), imag(H_AP(12,block)),...
          real(H_AP(13,block)), imag(H_AP(13,block)),real(H_AP(14,block)), imag(H_AP(14,block)),real(H_AP(15,block)), imag(H_AP(15,block)),...
          real(H_AP(16,block)), imag(H_AP(16,block)),real(H_AP(17,block)), imag(H_AP(17,block)),real(H_AP(18,block)), imag(H_AP(18,block)),...
          real(H_AP(19,block)), imag(H_AP(19,block)),real(H_AP(20,block)), imag(H_AP(20,block)));     

% 25 Aps
% fprintf(fileID4,'%.5f %.5f %.5f %.5f %.5f %.5f %.5f %.5f %.5f %.5f %.5f %.5f %.5f %.5f %.5f %.5f %.5f %.5f %.5f %.5f %.5f %.5f %.5f %.5f %.5f %.5f %.5f %.5f %.5f %.5f %.5f %.5f %.5f %.5f %.5f %.5f %.5f %.5f %.5f %.5f %.5f %.5f %.5f %.5f %.5f %.5f %.5f %.5f %.5f %.5f\n',...
%           real(H_AP(1,block)), imag(H_AP(1,block)),real(H_AP(2,block)),imag(H_AP(2,block)),real(H_AP(3,block)), imag(H_AP(3,block)),...
%           real(H_AP(4,block)), imag(H_AP(4,block)),real(H_AP(5,block)),imag(H_AP(5,block)),real(H_AP(6,block)), imag(H_AP(6,block)),...
%           real(H_AP(7,block)), imag(H_AP(7,block)),real(H_AP(8,block)),imag(H_AP(8,block)),real(H_AP(9,block)), imag(H_AP(9,block)),...
%           real(H_AP(10,block)), imag(H_AP(10,block)),real(H_AP(11,block)), imag(H_AP(11,block)),real(H_AP(12,block)), imag(H_AP(12,block)),...
%           real(H_AP(13,block)), imag(H_AP(13,block)),real(H_AP(14,block)), imag(H_AP(14,block)),real(H_AP(15,block)), imag(H_AP(15,block)),...
%           real(H_AP(16,block)), imag(H_AP(16,block)),real(H_AP(17,block)), imag(H_AP(17,block)),real(H_AP(18,block)), imag(H_AP(18,block)),...
%           real(H_AP(19,block)), imag(H_AP(19,block)),real(H_AP(20,block)), imag(H_AP(20,block)),real(H_AP(21,block)), imag(H_AP(21,block)),... 
%           real(H_AP(22,block)), imag(H_AP(22,block)),real(H_AP(23,block)), imag(H_AP(23,block)),real(H_AP(24,block)), imag(H_AP(24,block)),...
%           real(H_AP(25,block)), imag(H_AP(25,block)));     


%50 APs
%fprintf(fileID4,'%.5f %.5f %.5f %.5f %.5f %.5f %.5f %.5f %.5f %.5f %.5f %.5f %.5f %.5f %.5f %.5f %.5f %.5f %.5f %.5f %.5f %.5f %.5f %.5f %.5f %.5f %.5f %.5f %.5f %.5f %.5f %.5f %.5f %.5f %.5f %.5f %.5f %.5f %.5f %.5f %.5f %.5f %.5f %.5f %.5f %.5f %.5f %.5f %.5f %.5f %.5f %.5f %.5f %.5f %.5f %.5f %.5f %.5f %.5f %.5f %.5f %.5f %.5f %.5f %.5f %.5f %.5f %.5f %.5f %.5f %.5f %.5f %.5f %.5f %.5f %.5f %.5f %.5f %.5f %.5f %.5f %.5f %.5f %.5f %.5f %.5f %.5f %.5f %.5f %.5f %.5f %.5f %.5f %.5f %.5f %.5f %.5f %.5f %.5f %.5f\n',...
%          real(H_AP(1,block)), imag(H_AP(1,block)),real(H_AP(2,block)),imag(H_AP(2,block)),real(H_AP(3,block)), imag(H_AP(3,block)),...
%          real(H_AP(4,block)), imag(H_AP(4,block)),real(H_AP(5,block)),imag(H_AP(5,block)),real(H_AP(6,block)), imag(H_AP(6,block)),...
%          real(H_AP(7,block)), imag(H_AP(7,block)),real(H_AP(8,block)),imag(H_AP(8,block)),real(H_AP(9,block)), imag(H_AP(9,block)),...
%          real(H_AP(10,block)), imag(H_AP(10,block)),real(H_AP(11,block)), imag(H_AP(11,block)),real(H_AP(12,block)), imag(H_AP(12,block)),...
%          real(H_AP(13,block)), imag(H_AP(13,block)),real(H_AP(14,block)), imag(H_AP(14,block)),real(H_AP(15,block)), imag(H_AP(15,block)),...
%          real(H_AP(16,block)), imag(H_AP(16,block)),real(H_AP(17,block)), imag(H_AP(17,block)),real(H_AP(18,block)), imag(H_AP(18,block)),...
%          real(H_AP(19,block)), imag(H_AP(19,block)),real(H_AP(20,block)), imag(H_AP(20,block)),real(H_AP(21,block)), imag(H_AP(21,block)),... 
%          real(H_AP(22,block)), imag(H_AP(22,block)),real(H_AP(23,block)), imag(H_AP(23,block)),real(H_AP(24,block)), imag(H_AP(24,block)),...
%          real(H_AP(25,block)), imag(H_AP(25,block)),real(H_AP(26,block)), imag(H_AP(26,block)),real(H_AP(27,block)), imag(H_AP(27,block)),...
%          real(H_AP(28,block)), imag(H_AP(28,block)),real(H_AP(29,block)), imag(H_AP(29,block)),real(H_AP(30,block)), imag(H_AP(30,block)),...
%          real(H_AP(31,block)), imag(H_AP(31,block)),real(H_AP(32,block)), imag(H_AP(32,block)),real(H_AP(33,block)), imag(H_AP(33,block)),...
%          real(H_AP(34,block)), imag(H_AP(34,block)),real(H_AP(35,block)), imag(H_AP(35,block)),real(H_AP(36,block)), imag(H_AP(36,block)),...
%          real(H_AP(37,block)), imag(H_AP(37,block)),real(H_AP(38,block)), imag(H_AP(38,block)),real(H_AP(39,block)), imag(H_AP(39,block)),...
%          real(H_AP(40,block)), imag(H_AP(40,block)),real(H_AP(41,block)), imag(H_AP(41,block)),real(H_AP(42,block)), imag(H_AP(42,block)),...
%          real(H_AP(43,block)), imag(H_AP(43,block)),real(H_AP(44,block)), imag(H_AP(44,block)),real(H_AP(45,block)), imag(H_AP(45,block)),...
%          real(H_AP(46,block)), imag(H_AP(46,block)),real(H_AP(47,block)), imag(H_AP(47,block)),real(H_AP(48,block)), imag(H_AP(48,block)),...
%          real(H_AP(49,block)), imag(H_AP(49,block)),real(H_AP(50,block)), imag(H_AP(50,block)));  


 
end



end
    
end
fclose(fileID3);
fclose(fileID4);
